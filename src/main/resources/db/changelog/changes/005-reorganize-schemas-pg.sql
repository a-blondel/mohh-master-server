--liquibase formatted sql

--changeset dbms:postgresql
-- Create new schemas
CREATE SCHEMA IF NOT EXISTS core;
CREATE SCHEMA IF NOT EXISTS stats;

-- Drop fk constraints that reference public schema tables
ALTER TABLE public.PERSONA DROP CONSTRAINT IF EXISTS FK_PERSONA_ACCOUNT_ID;
ALTER TABLE public.PERSONA_STATS DROP CONSTRAINT IF EXISTS FK_PERSONA_STATS_PERSONA_ID;
ALTER TABLE public.PERSONA_CONNECTION DROP CONSTRAINT IF EXISTS FK_CONNECTIONS_ACCOUNT_ID;
ALTER TABLE public.GAME_REPORT DROP CONSTRAINT IF EXISTS FK_GAME_REPORT_GAME_ID;
ALTER TABLE public.GAME_REPORT DROP CONSTRAINT IF EXISTS FK_GAME_REPORT_PERSONA_CONNECTION_ID;

-- Drop fk constraints that reference social schema tables
ALTER TABLE social.MESSAGE DROP CONSTRAINT IF EXISTS FK_MESSAGE_FROM_PERSONA_ID;
ALTER TABLE social.MESSAGE DROP CONSTRAINT IF EXISTS FK_MESSAGE_TO_PERSONA_ID;
ALTER TABLE social.FEEDBACK DROP CONSTRAINT IF EXISTS FK_FEEDBACK_FROM_PERSONA_ID;
ALTER TABLE social.FEEDBACK DROP CONSTRAINT IF EXISTS FK_FEEDBACK_TO_PERSONA_ID;
ALTER TABLE social.BUDDY DROP CONSTRAINT IF EXISTS FK_BUDDY_FROM_PERSONA_ID;
ALTER TABLE social.BUDDY DROP CONSTRAINT IF EXISTS FK_BUDDY_TO_PERSONA_ID;

-- Move tables to the core schema
ALTER TABLE public.ACCOUNT SET SCHEMA core;
ALTER TABLE public.BLACKLIST SET SCHEMA core;
ALTER TABLE public.PERSONA SET SCHEMA core;
ALTER TABLE public.PERSONA_CONNECTION SET SCHEMA core;
ALTER TABLE public.GAME SET SCHEMA core;

-- Create GAME_CONNECTION table (rename GAME_REPORT and keep only connection-specific columns)
CREATE TABLE core.GAME_CONNECTION (
    ID bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    GAME_ID bigint NOT NULL,
    IS_HOST boolean NOT NULL,
    PERSONA_CONNECTION_ID bigint NOT NULL,
    START_TIME timestamp NOT NULL,
    END_TIME timestamp
);
INSERT INTO core.GAME_CONNECTION (ID, GAME_ID, IS_HOST, PERSONA_CONNECTION_ID, START_TIME, END_TIME)
SELECT ID, GAME_ID, IS_HOST, PERSONA_CONNECTION_ID, START_TIME, END_TIME FROM public.GAME_REPORT;

-- Update the sequence to continue from the highest ID to avoid conflicts
SELECT setval('core.game_connection_id_seq', (SELECT MAX(ID) FROM core.GAME_CONNECTION));

-- Create MOHH_GAME_REPORT table with GAME_CONNECTION_ID as primary key
CREATE TABLE stats.MOHH_GAME_REPORT (
    GAME_CONNECTION_ID bigint PRIMARY KEY NOT NULL,
    KILL numeric NOT NULL DEFAULT 0,
    DEATH numeric NOT NULL DEFAULT 0,
    SHOT numeric NOT NULL DEFAULT 0,
    HIT numeric NOT NULL DEFAULT 0,
    HEAD numeric NOT NULL DEFAULT 0,
    COLTSHOT numeric NOT NULL DEFAULT 0,
    COLTHIT numeric NOT NULL DEFAULT 0,
    COLTKILL numeric NOT NULL DEFAULT 0,
    COLTHEAD numeric NOT NULL DEFAULT 0,
    TOMSHOT numeric NOT NULL DEFAULT 0,
    TOMHIT numeric NOT NULL DEFAULT 0,
    TOMKILL numeric NOT NULL DEFAULT 0,
    TOMHEAD numeric NOT NULL DEFAULT 0,
    BARSHOT numeric NOT NULL DEFAULT 0,
    BARHIT numeric NOT NULL DEFAULT 0,
    BARKILL numeric NOT NULL DEFAULT 0,
    BARHEAD numeric NOT NULL DEFAULT 0,
    GARSHOT numeric NOT NULL DEFAULT 0,
    GARHIT numeric NOT NULL DEFAULT 0,
    GARKILL numeric NOT NULL DEFAULT 0,
    GARHEAD numeric NOT NULL DEFAULT 0,
    ENFIELDSHOT numeric NOT NULL DEFAULT 0,
    ENFIELDHIT numeric NOT NULL DEFAULT 0,
    ENFIELDKILL numeric NOT NULL DEFAULT 0,
    ENFIELDHEAD numeric NOT NULL DEFAULT 0,
    SHOTTYSHOT numeric NOT NULL DEFAULT 0,
    SHOTTYHIT numeric NOT NULL DEFAULT 0,
    SHOTTYKILL numeric NOT NULL DEFAULT 0,
    SHOTTYHEAD numeric NOT NULL DEFAULT 0,
    BAZSHOT numeric NOT NULL DEFAULT 0,
    BAZHIT numeric NOT NULL DEFAULT 0,
    BAZKILL numeric NOT NULL DEFAULT 0,
    BAZHEAD numeric NOT NULL DEFAULT 0,
    LUGERSHOT numeric NOT NULL DEFAULT 0,
    LUGERHIT numeric NOT NULL DEFAULT 0,
    LUGERKILL numeric NOT NULL DEFAULT 0,
    LUGERHEAD numeric NOT NULL DEFAULT 0,
    MP40SHOT numeric NOT NULL DEFAULT 0,
    MP40HIT numeric NOT NULL DEFAULT 0,
    MP40KILL numeric NOT NULL DEFAULT 0,
    MP40HEAD numeric NOT NULL DEFAULT 0,
    MP44SHOT numeric NOT NULL DEFAULT 0,
    MP44HIT numeric NOT NULL DEFAULT 0,
    MP44KILL numeric NOT NULL DEFAULT 0,
    MP44HEAD numeric NOT NULL DEFAULT 0,
    KARSHOT numeric NOT NULL DEFAULT 0,
    KARHIT numeric NOT NULL DEFAULT 0,
    KARKILL numeric NOT NULL DEFAULT 0,
    KARHEAD numeric NOT NULL DEFAULT 0,
    GEWRSHOT numeric NOT NULL DEFAULT 0,
    GEWRHIT numeric NOT NULL DEFAULT 0,
    GEWRKILL numeric NOT NULL DEFAULT 0,
    GEWRHEAD numeric NOT NULL DEFAULT 0,
    PANZSHOT numeric NOT NULL DEFAULT 0,
    PANZHIT numeric NOT NULL DEFAULT 0,
    PANZKILL numeric NOT NULL DEFAULT 0,
    PANZHEAD numeric NOT NULL DEFAULT 0,
    GRENTHROW numeric NOT NULL DEFAULT 0,
    GRENKILL numeric NOT NULL DEFAULT 0,
    MELEEKILL numeric NOT NULL DEFAULT 0,
    WIN numeric NOT NULL DEFAULT 0,
    LOSS numeric NOT NULL DEFAULT 0,
    AXIS numeric NOT NULL DEFAULT 0,
    ALLIES numeric NOT NULL DEFAULT 0,
    DMRND numeric NOT NULL DEFAULT 0,
    CTFAXIS numeric NOT NULL DEFAULT 0,
    CTFALLIES numeric NOT NULL DEFAULT 0,
    DEMAXIS numeric NOT NULL DEFAULT 0,
    DEMALLIES numeric NOT NULL DEFAULT 0,
    CAPAXIS numeric NOT NULL DEFAULT 0,
    CAPALLIES numeric NOT NULL DEFAULT 0,
    KOHAXIS numeric NOT NULL DEFAULT 0,
    KOHALLIES numeric NOT NULL DEFAULT 0,
    BLAXIS numeric NOT NULL DEFAULT 0,
    BLALLIES numeric NOT NULL DEFAULT 0,
    TDMAXIS numeric NOT NULL DEFAULT 0,
    TDMALLIES numeric NOT NULL DEFAULT 0,
    MAP1 numeric NOT NULL DEFAULT 0,
    MAP2 numeric NOT NULL DEFAULT 0,
    MAP3 numeric NOT NULL DEFAULT 0,
    MAP4 numeric NOT NULL DEFAULT 0,
    MAP5 numeric NOT NULL DEFAULT 0,
    MAP6 numeric NOT NULL DEFAULT 0,
    MAP7 numeric NOT NULL DEFAULT 0,
    MAP8 numeric NOT NULL DEFAULT 0,
    MAP9 numeric NOT NULL DEFAULT 0,
    MAP10 numeric NOT NULL DEFAULT 0,
    MAP11 numeric NOT NULL DEFAULT 0,
    MAP12 numeric NOT NULL DEFAULT 0,
    MAP13 numeric NOT NULL DEFAULT 0,
    MAP14 numeric NOT NULL DEFAULT 0,
    MAP15 numeric NOT NULL DEFAULT 0,
    MAP16 numeric NOT NULL DEFAULT 0,
    MAP17 numeric NOT NULL DEFAULT 0,
    MAP18 numeric NOT NULL DEFAULT 0,
    MAP19 numeric NOT NULL DEFAULT 0,
    MAP20 numeric NOT NULL DEFAULT 0,
    MAP21 numeric NOT NULL DEFAULT 0,
    MAP22 numeric NOT NULL DEFAULT 0,
    MAP23 numeric NOT NULL DEFAULT 0,
    MAP24 numeric NOT NULL DEFAULT 0,
    MAP25 numeric NOT NULL DEFAULT 0,
    MAP26 numeric NOT NULL DEFAULT 0,
    MAP27 numeric NOT NULL DEFAULT 0,
    MAP28 numeric NOT NULL DEFAULT 0,
    PLAYTIME numeric NOT NULL DEFAULT 0,
    SERVTYPE numeric NOT NULL DEFAULT 0,
    AUTH varchar(255),
    RNK numeric NOT NULL DEFAULT 0
);
INSERT INTO stats.MOHH_GAME_REPORT (GAME_CONNECTION_ID, KILL, DEATH, SHOT, HIT, HEAD, COLTSHOT, COLTHIT, COLTKILL, COLTHEAD, TOMSHOT, TOMHIT, TOMKILL, TOMHEAD, BARSHOT, BARHIT, BARKILL, BARHEAD, GARSHOT, GARHIT, GARKILL, GARHEAD, ENFIELDSHOT, ENFIELDHIT, ENFIELDKILL, ENFIELDHEAD, SHOTTYSHOT, SHOTTYHIT, SHOTTYKILL, SHOTTYHEAD, BAZSHOT, BAZHIT, BAZKILL, BAZHEAD, LUGERSHOT, LUGERHIT, LUGERKILL, LUGERHEAD, MP40SHOT, MP40HIT, MP40KILL, MP40HEAD, MP44SHOT, MP44HIT, MP44KILL, MP44HEAD, KARSHOT, KARHIT, KARKILL, KARHEAD, GEWRSHOT, GEWRHIT, GEWRKILL, GEWRHEAD, PANZSHOT, PANZHIT, PANZKILL, PANZHEAD, GRENTHROW, GRENKILL, MELEEKILL, WIN, LOSS, AXIS, ALLIES, DMRND, CTFAXIS, CTFALLIES, DEMAXIS, DEMALLIES, CAPAXIS, CAPALLIES, KOHAXIS, KOHALLIES, BLAXIS, BLALLIES, TDMAXIS, TDMALLIES, MAP1, MAP2, MAP3, MAP4, MAP5, MAP6, MAP7, MAP8, MAP9, MAP10, MAP11, MAP12, MAP13, MAP14, MAP15, MAP16, MAP17, MAP18, MAP19, MAP20, MAP21, MAP22, MAP23, MAP24, MAP25, MAP26, MAP27, MAP28, PLAYTIME, SERVTYPE, AUTH, RNK)
SELECT ID, KILL, DEATH, SHOT, HIT, HEAD, COLTSHOT, COLTHIT, COLTKILL, COLTHEAD, TOMSHOT, TOMHIT, TOMKILL, TOMHEAD, BARSHOT, BARHIT, BARKILL, BARHEAD, GARSHOT, GARHIT, GARKILL, GARHEAD, ENFIELDSHOT, ENFIELDHIT, ENFIELDKILL, ENFIELDHEAD, SHOTTYSHOT, SHOTTYHIT, SHOTTYKILL, SHOTTYHEAD, BAZSHOT, BAZHIT, BAZKILL, BAZHEAD, LUGERSHOT, LUGERHIT, LUGERKILL, LUGERHEAD, MP40SHOT, MP40HIT, MP40KILL, MP40HEAD, MP44SHOT, MP44HIT, MP44KILL, MP44HEAD, KARSHOT, KARHIT, KARKILL, KARHEAD, GEWRSHOT, GEWRHIT, GEWRKILL, GEWRHEAD, PANZSHOT, PANZHIT, PANZKILL, PANZHEAD, GRENTHROW, GRENKILL, MELEEKILL, WIN, LOSS, AXIS, ALLIES, DMRND, CTFAXIS, CTFALLIES, DEMAXIS, DEMALLIES, CAPAXIS, CAPALLIES, KOHAXIS, KOHALLIES, BLAXIS, BLALLIES, TDMAXIS, TDMALLIES, MAP1, MAP2, MAP3, MAP4, MAP5, MAP6, MAP7, MAP8, MAP9, MAP10, MAP11, MAP12, MAP13, MAP14, MAP15, MAP16, MAP17, MAP18, MAP19, MAP20, MAP21, MAP22, MAP23, MAP24, MAP25, MAP26, MAP27, MAP28, PLAYTIME, SERVTYPE, AUTH, RNK FROM public.GAME_REPORT;

-- Drop old table
DROP TABLE public.GAME_REPORT;

-- Move PERSONA_STATS to stats schema and rename
ALTER TABLE public.PERSONA_STATS SET SCHEMA stats;
ALTER TABLE stats.PERSONA_STATS RENAME TO MOHH_PERSONA_STATS;

-- Recreate the foreign key constraints
ALTER TABLE core.PERSONA ADD CONSTRAINT FK_PERSONA_ACCOUNT_ID
    FOREIGN KEY (ACCOUNT_ID) REFERENCES core.ACCOUNT(ID);

ALTER TABLE stats.MOHH_PERSONA_STATS ADD CONSTRAINT FK_MOHH_PERSONA_STATS_PERSONA_ID
    FOREIGN KEY (PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE core.PERSONA_CONNECTION ADD CONSTRAINT FK_PERSONA_CONNECTION_PERSONA_ID
    FOREIGN KEY (PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE core.GAME_CONNECTION ADD CONSTRAINT FK_GAME_CONNECTION_GAME_ID
    FOREIGN KEY (GAME_ID) REFERENCES core.GAME(ID);

ALTER TABLE core.GAME_CONNECTION ADD CONSTRAINT FK_GAME_CONNECTION_PERSONA_CONNECTION_ID
    FOREIGN KEY (PERSONA_CONNECTION_ID) REFERENCES core.PERSONA_CONNECTION(ID);

ALTER TABLE stats.MOHH_GAME_REPORT ADD CONSTRAINT FK_MOHH_GAME_REPORT_GAME_CONNECTION_ID
    FOREIGN KEY (GAME_CONNECTION_ID) REFERENCES core.GAME_CONNECTION(ID);

ALTER TABLE social.MESSAGE ADD CONSTRAINT FK_MESSAGE_FROM_PERSONA_ID
    FOREIGN KEY (FROM_PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE social.MESSAGE ADD CONSTRAINT FK_MESSAGE_TO_PERSONA_ID
    FOREIGN KEY (TO_PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE social.FEEDBACK ADD CONSTRAINT FK_FEEDBACK_FROM_PERSONA_ID
    FOREIGN KEY (FROM_PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE social.FEEDBACK ADD CONSTRAINT FK_FEEDBACK_TO_PERSONA_ID
    FOREIGN KEY (TO_PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE social.BUDDY ADD CONSTRAINT FK_BUDDY_FROM_PERSONA_ID
    FOREIGN KEY (FROM_PERSONA_ID) REFERENCES core.PERSONA(ID);

ALTER TABLE social.BUDDY ADD CONSTRAINT FK_BUDDY_TO_PERSONA_ID
    FOREIGN KEY (TO_PERSONA_ID) REFERENCES core.PERSONA(ID);
